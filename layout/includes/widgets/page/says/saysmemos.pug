ul.list#waterfall
    script.
        (()=>{
            fetch("!{url_for(theme.says.mode_link)}").then(res => res.json()).then(data => {
                let items = [],
                    html = '',
                    strip = !{theme.says.strip},
                    saysTips = '';
                
                if (strip === -1 || strip >= data.length) {
                    data.forEach(item => { items.push(saysFormat(item)) });
                    saysTips = `<div id="bber-tips">- 已展开所有短文 -</div>`
                } else {
                    data.slice(0, strip).forEach(item => {
                        items.push(saysFormat(item));
                    });
                    saysTips = `<div id="bber-tips">- 只展示最近 ${strip} 条短文 -</div>`
                }

                document.getElementsByClassName('list')[0].innerHTML = items.map(item => item.content).join('');
                document.querySelector(".page-1").insertAdjacentHTML("beforeend", saysTips)
                changeTimeFormat()
                sco.reflashEssayWaterFall()
                sco.lazyloadImg()
            });

            function saysFormat(item) {
                let style = !{theme.says.style},
                    time = new Date(item.createdTs * 1000).toISOString().replace('Z', '+08:00'),
                    content = item.content,
                    image = content.match(/!\[.*\]\(.*?\)/g), 
                    aplayer = content.match(/{\s*music\s*(.*?)\s*(.*?)\s*}/g),
                    player = content.match(/{\s*player\s*(.*)\s*}/g),
                    bilibili = content.match(/{\s*bilibili\s*(.*?)\s*}/g),
                    text = '',
                    onclick = '',
                    link = '',
                    saysLink = '',
                    saysContent = '',
                    saysContents = '';

                if (image) image = image.map(item => { return item.replace(/!\[.*\]\((.*?)\)/, '$1'); });
                if (item.resourceList.length) {
                    if (!image) image = [];
                    item.resourceList.forEach(t => {
                        if (t.externalLink) image.push(t.externalLink);
                        else image.push(`{url}/o/r/${t.id}/${t.publicId}/${t.filename}`);
                    });
                }

                text = content.replace(/#(.*?)\s/g, '').replace(/\!\[(.*?)\]\((.*?)\)/g, '').replace(/\{(.*?)\}/g, '');
                content = text.replace(/\[(.*?)\]\((.*?)\)/g, (match, p1, p2) => {
                    link = p2;
                    return ``;
                });
                saysContent = `<p class="datacont">${content}</p>`;

                if (text) {
                    onclick = `<a class="bber-reply goComment" ${content}><i class="scoicon sco-chat-fill" style="font-size:1rem"></i></a>`
                }

                if (image) {
                    saysContent += `<div class="bber-content-img">`;
                    image.forEach(e => saysContent += `<img src="${e}" title="即刻短文配图" />`);
                    saysContent += '</div>';
                }

                if (aplayer) aplayer.forEach(item => {
                    const music = item.match(/{\s*music\s*(\S+)\s*(\S+)\s*}/);
                    saysContents += `<div class="bber-music"><meting-js server="${music[1]}" type="song" id="${music[2]}" mutex="true" preload="none" theme="var(--sco-main)" data-lrctype="0"></meting-js></div>`
                })

                if (player) player.forEach(item => {
                    saysContents += `<div class="bber-video"><video src="${item.replace(/{\s*player\s*(.*)\s*}/, '$1')}" controls="controls" style="object-fit: cover;"></video></div>`
                })
                if (bilibili) bilibili.forEach(item => {
                    let bvid = item.match(/BV(\w+)/);
                    saysContents += `<div class="bber-video"><iframe src="//player.bilibili.com/player.html?autoplay=0&bvid=BV${bvid[1]}" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe></div>`
                })

                if (link) {
                    saysLink = `<a class="bber-content-link href="${link}" title="跳转到短文指引的链接"><i class="scoicon sco-link-m-line"></i>链接</a>`;
                }
                
                if  (style === 1) {
                    return {
                        content: `
                            <li class="item">
                                <div id="bber-content">
                                    ${saysContent}
                                </div>
                                ${saysContents}
                                <hr>
                                <div class="bber-bottom">
                                    <div class="bber-info">
                                        <div class="bber-info-time">
                                            <i class="scoicon sco-calendar-todo-fill"></i>
                                            <time class="datatime" datetime="${time}"></time>
                                        </div>
                                        ${saysLink}
                                    </div>
                                    ${onclick}
                                </div>
                            </li>`
                    };
                } else if (style === 2) {
                    return {
                        content: `
                            <li class="item">
                                <div class="meta">
                                    <img class="no-lightbox no-lazyload avatar" src="!{theme.aside.card.author.img}">
                                    <div class="info">
                                        <span class="bber_nick">#{config.author}</span>
                                        <time class="datetime bber_date" datetime="${time}"></time>
                                    </div>
                                    ${onclick}
                                </div>
                                <div id="bber-content">
                                    ${saysContent}
                                </div>
                                ${saysContents}
                            </li>`
                    };
                } else {
                    console.log('请正确配置即刻样式！')
                }
            }
        })()