- const { envId, region, option ,accessToken } = theme.twikoo
- const { lazyload, count, use,commentBarrage } = theme.comment

script.
    !function () {
        const getCount = () => {
            const countELement = document.getElementById('twikoo-count')
            if (!countELement) return
            twikoo.getCommentsCount({
                envId: '!{envId}',
                region: '!{region}',
                urls: [window.location.pathname],
                includeReply: false
            }).then(res => {
                countELement.textContent = res[0].count
            }).catch(err => {
                console.error(err)
            })
        }
        const init = async () => {
            twikoo.init(Object.assign({
                el: '#twikoo-wrap',
                envId: '!{envId}',
                region: '!{region}',
                onCommentLoaded: () => {
                    utils.lightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
                }
            }, !{JSON.stringify(option)}))

            !{count ? ' PAGE_CONFIG.is_post && getCount()' : ''}
            sco.owoBig({
                body: '.OwO-body',
                item: '.OwO-items li'
            })

            !{commentBarrage} && getBarrage()
        }

        const loadTwikoo = () => {
            if (typeof twikoo === 'object') init()
            else utils.getScript('!{url_for(theme.cdn.twikoo)}').then(init)
        }

        if ('!{use[0]}' === 'Twikoo' || !{lazyload}) {
            if (!{lazyload}) utils.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
            else loadTwikoo()
        } else {
            window.loadTwoComment = init
        }
    }()

if commentBarrage
    script.
        async function getBarrage() {
            try {
                const response = await fetch("!{envId}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        event: "COMMENT_GET",
                        accessToken: "!{accessToken}",
                        url: window.location.pathname
                    })
                });
                if (!response.ok) {
                    throw new Error("HTTP error! status: " + response.status);
                }
                const data = await response.json();
                await utils.getScript('!{url_for(theme.cdn.commentBarrage)}').then(() => {
                    initializeCommentBarrage((data.data).map(item => Object.assign({
                        content: item.comment,
                        nick: item.nick,
                        mailMd5: item.mailMd5,
                        id: item.id
                    })))
                })
            } catch (error) {
                console.error("An error occurred while fetching comments: ", error);
            }
        }